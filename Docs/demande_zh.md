# 需求说明

## 1. 项目需求描述

### 1.1 目标
- 开发一个基于 C++ 的多层感知机（MLP），能够识别 MNIST 手写数字。
- 构建一个反向模式自动微分引擎，用于自动生成模型梯度。
- 集成完整的训练流程（前向传播、反向传播、SGD、激活函数、初始化），在第一学期末交付可用的 MNIST 求解器。
- 为第二学期的性能和精度提升奠定基础。

### 1.2 项目产品
- 一个提供 MNIST MLP 实现的 C++ 库/工具，内含自动微分引擎、关键优化算法以及数据读取管线。
- 技术文档和使用示例，用于指导模型的训练与评估。

### 1.3 产品功能
- 可配置的 MLP 前向传播（层数、规模、激活函数可调）。
- 反向模式自动微分引擎，生成计算图及对应的梯度。
- 支持向量/矩阵运算（矩阵乘、逐元素和、逐元素乘、逐元素激活）及其偏导数计算。
- 训练循环包含 SGD 权重/偏置更新、可控的随机初始化和性能跟踪。
- 集成 MNIST 数据装载流程，并提供推理接口以预测手写数字。

### 1.4 可接受性与验收标准
- 在 MNIST 验证集上的准确率不低于既定阈值（示例：第一学期末达到 ≥90%）。
- 通过数值差分对比验证梯度计算正确性（在选定的测试用例上）。
- 满足目标硬件上的性能要求（训练时间合理）并通过关键运算的单元测试。
- 提供完整文档，按说明即可运行端到端训练与推理流程。

## 2. 约束条件

### 2.1 进度约束
- **11.08 设计阶段结束**
  - 交付系统总体架构（模块划分、数据流、依赖关系）与接口定义文档。
  - 确认技术选型（C++17、OpenBLAS、测试框架等）及环境搭建脚本。
  - 输出详细迭代计划与风险清单，经团队评审通过。
- **11.16 第一个可运行版本**
  - 完成基础 MLP 前向传播、反向模式自动微分引擎、SGD/损失函数骨架并联调。
  - 通过核心矩阵/向量运算与梯度计算的单元测试，误差不超过数值差分 1e-5。
  - 在抽样 MNIST mini-batch 上完成一次前向+反向+参数更新，loss 呈下降趋势并提供运行指南。
- **12.07 第二个版本**
  - 集成完整 MNIST 训练管线（数据加载、mini-batch 训练、性能指标记录），支持可配置网络结构。
  - 在验证集上达到 ≥90% 准确率或给出不足原因及改进计划。
  - 完成文档初稿（使用说明、测试报告、已知问题），具备演示和交付条件。

### 2.3 物料约束
- Linux 系统的电脑，VSCODE作为编译器

### 2.4 其他约束
- C++
- OpenBLAS库
- _待补充：技术标准、法律条款、安全要求等_

## 3. 项目实施

### 3.1 计划安排
- **第一学期——核心功能实现**
  1. 开发具备前向传播能力的基础 MLP。
  2. 构建反向模式自动微分引擎，覆盖向量/矩阵运算（求和、乘法）及元素级激活函数，包括能够计算这些运算的偏导数。
  3. 将自动微分与 MLP 集成以计算梯度。
  4. 实现包含 SGD 的训练流程（权重、偏置、激活函数管理）。
  5. 基于提供的数据读取代码整合完整的 MNIST 训练管线。

- **第二学期——性能与效果优化**
  - 优化精度与训练速度（模型结构、正则化、超参数调优等）。

### 3.2 资源配置
- 人力资源：4名 C++ 开发者，和一个encadrant的技术支持。
- 物理资源：支持 C++17+ 的开发环境，常用标准库，具备训练 MNIST 所需的计算能力（多核 CPU，可选 GPU）。


# 自动微分 + MLP + MNIST 分解项目

## 🎯 总体目标
1. 开发具备前向传播能力的基础 MLP。
2. 构建反向模式自动微分引擎，支持矩阵/向量运算及激活函数，并能计算偏导。
3. 将自动微分与 MLP 集成，实现梯度计算。
4. 实现包含 SGD 的训练流程，支持权重、偏置与激活函数管理。
5. 使用提供的代码整合 MNIST 训练与评估管线。

---

## 🧩 阶段一：基础 MLP 前向传播

### 1. 数据结构与数学基础
- [ ] 实现 `Matrix` / `Vector` 类（支持加法、乘法、转置、广播）
- [ ] 添加随机初始化与打印函数
- [ ] 编写单元测试，验证矩阵运算正确性

### 2. 激活函数模块
- [ ] 定义抽象类 `ActivationFunction`（接口：`forward`, `backward`）
- [ ] 实现 `ReLU`, `Sigmoid`, `Tanh`
- [ ] 编写测试验证输出是否正确

### 3. 线性层模块
- [ ] 定义 `LinearLayer(in_dim, out_dim)` 类
- [ ] 实现 `forward(x) = x @ W + b`
- [ ] 添加随机初始化（高斯或均匀分布）
- [ ] 测试输入输出维度是否正确

### 4. 组装基础 MLP
- [ ] 定义 `MLPNetwork` 类，包含 `Linear + Activation`
- [ ] 实现 `addLayer()`、`forward(input)`
- [ ] 手动测试网络结构是否工作

---

## ⚙️ 阶段二：自动微分引擎（Autodiff Engine）

### 5. 节点与计算图基础
- [ ] 实现 `Node` 类：`value`, `grad`, `parents`, `backward_fn`
- [ ] 支持 `backward()` 自动拓扑排序回传梯度
- [ ] 测试标量加法/乘法的反向传播结果

### 6. 向量/矩阵运算支持
- [ ] 实现 `add`, `mul`（逐元素）及其反向规则
- [ ] 实现 `matmul`（矩阵乘法）及反向规则：
  - `dA += grad_output @ Bᵀ`
  - `dB += Aᵀ @ grad_output`
- [ ] 测试矩阵乘法梯度是否正确

### 7. 激活函数的自动微分
- [ ] 在自动微分框架中注册 `relu`, `sigmoid`, `tanh`
- [ ] 实现各自的反向规则
- [ ] 数值梯度检查验证正确性

### 8. 聚合操作
- [ ] 实现 `sum`, `mean` 操作及其反向传播
- [ ] 确保梯度能正确广播

---

## 🔁 阶段三：MLP 集成自动微分

### 9. 改写 MLP 前向为可构建计算图
- [ ] 将 `Matrix` 替换为 `TensorNode`
- [ ] 所有层运算基于自动微分节点实现

### 10. MLP 梯度计算
- [ ] 调用 `loss.backward()` 自动计算梯度
- [ ] 从参数节点（W, b）中提取 `.grad`

### 11. 梯度验证
- [ ] 用数值差分法对比自动微分结果
- [ ] 在简单函数（线性回归）上测试正确性

---

## ⚙️ 阶段四：训练机制（SGD + 初始化 + 激活）

### 12. 损失函数模块
- [ ] 实现 `MSELoss(pred, target)`
- [ ] （可选）实现 `CrossEntropyLoss`
- [ ] 验证损失及反向传播正确性

### 13. 优化器模块
- [ ] 定义抽象类 `Optimizer`
- [ ] 实现 `SGDOptimizer`（含 `step()` 与 `zero_grad()`）
- [ ] 在简单函数上验证下降趋势

### 14. 初始化策略
- [ ] 实现 `Xavier` 与 `Kaiming` 初始化方法
- [ ] 根据激活函数自动选择初始化策略

### 15. 完整训练循环
- [ ] 定义 `train_step()`：前向 → loss → backward → update
- [ ] 打印每次迭代 loss 值
- [ ] 确认训练过程中 loss 连续下降

---

## 📊 阶段五：整合 MNIST 数据集

### 16. 数据加载
- [ ] 使用提供的读取函数加载 MNIST 数据
- [ ] 归一化输入数据到 [0,1] 或 [-1,1]
- [ ] 实现 DataLoader（mini-batch 生成器）

### 17. 网络结构定义
- [ ] 构建网络结构：

---

784 → 128 → 64 → 10
激活：ReLU
损失：CrossEntropy

---

- [ ] 初始化权重与偏置

### 18. 训练与评估
- [ ] 在 MNIST 上训练若干 epoch
- [ ] 记录 loss 与 accuracy 曲线
- [ ] 在测试集上评估准确率

---

## 🧠 阶段六：验证与文档

### 19. 验证正确性
- [ ] 检查梯度是否为零/爆炸
- [ ] 确认 loss 随训练轮次下降
- [ ] 评估最终准确率（目标 ≥ 88–92%）

### 20. 实验与分析
- [ ] 绘制 Loss/Accuracy 曲线
- [ ] 比较不同初始化与激活函数效果

### 21. 文档与交付
- [ ] 编写设计文档与 UML 类图
- [ ] 更新 README，说明运行方法
- [ ] 生成实验报告与结果图表

---

## 🚀 可选扩展（加分项）
- [ ] 实现 Adam 优化器
- [ ] 支持 mini-batch 并行计算
- [ ] 实现 Softmax + 稳定交叉熵
- [ ] 学习率调度器（scheduler）
- [ ] 模型保存与加载（序列化）

---

## ✅ 验收标准
| 模块 | 目标 |
|------|------|
| 自动微分 | 支持矩阵、激活、聚合操作的梯度计算 |
| MLP 前向 | 层结构正确、输出维度符合预期 |
| 梯度计算 | 自动微分梯度与数值梯度一致 |
| 训练 | Loss 连续下降 |
| MNIST | 准确率 ≥ 88–92% |
| 文档 | UML + 设计报告 + 使用说明齐全 |
